{"ast":null,"code":"module.exports = AFRAME.registerComponent('nav-agent', {\n  schema: {\n    destination: {\n      type: 'vec3'\n    },\n    active: {\n      default: false\n    },\n    speed: {\n      default: 2\n    }\n  },\n  init: function init() {\n    this.system = this.el.sceneEl.systems.nav;\n    this.system.addAgent(this);\n    this.group = null;\n    this.path = [];\n    this.raycaster = new THREE.Raycaster();\n  },\n  remove: function remove() {\n    this.system.removeAgent(this);\n  },\n  update: function update() {\n    this.path.length = 0;\n  },\n  updateNavLocation: function updateNavLocation() {\n    this.group = null;\n    this.path = [];\n  },\n  tick: function () {\n    var vDest = new THREE.Vector3();\n    var vDelta = new THREE.Vector3();\n    var vNext = new THREE.Vector3();\n    return function (t, dt) {\n      var el = this.el;\n      var data = this.data;\n      var raycaster = this.raycaster;\n      var speed = data.speed * dt / 1000;\n      if (!data.active) return; // Use PatrolJS pathfinding system to get shortest path to target.\n\n      if (!this.path.length) {\n        var position = this.el.object3D.position;\n        this.group = this.group || this.system.getGroup(position);\n        this.path = this.system.getPath(position, vDest.copy(data.destination), this.group) || [];\n        el.emit('navigation-start');\n      } // If no path is found, exit.\n\n\n      if (!this.path.length) {\n        console.warn('[nav] Unable to find path to %o.', data.destination);\n        this.el.setAttribute('nav-agent', {\n          active: false\n        });\n        el.emit('navigation-end');\n        return;\n      } // Current segment is a vector from current position to next waypoint.\n\n\n      var vCurrent = el.object3D.position;\n      var vWaypoint = this.path[0];\n      vDelta.subVectors(vWaypoint, vCurrent);\n      var distance = vDelta.length();\n      var gazeTarget;\n\n      if (distance < speed) {\n        // If <1 step from current waypoint, discard it and move toward next.\n        this.path.shift(); // After discarding the last waypoint, exit pathfinding.\n\n        if (!this.path.length) {\n          this.el.setAttribute('nav-agent', {\n            active: false\n          });\n          el.emit('navigation-end');\n          return;\n        }\n\n        vNext.copy(vCurrent);\n        gazeTarget = this.path[0];\n      } else {\n        // If still far away from next waypoint, find next position for\n        // the current frame.\n        vNext.copy(vDelta.setLength(speed)).add(vCurrent);\n        gazeTarget = vWaypoint;\n      } // Look at the next waypoint.\n\n\n      gazeTarget.y = vCurrent.y;\n      el.object3D.lookAt(gazeTarget); // Raycast against the nav mesh, to keep the agent moving along the\n      // ground, not traveling in a straight line from higher to lower waypoints.\n\n      raycaster.ray.origin.copy(vNext);\n      raycaster.ray.origin.y += 1.5;\n      raycaster.ray.direction.y = -1;\n      var intersections = raycaster.intersectObject(this.system.getNavMesh());\n\n      if (!intersections.length) {\n        // Raycasting failed. Step toward the waypoint and hope for the best.\n        vCurrent.copy(vNext);\n      } else {\n        // Re-project next position onto nav mesh.\n        vDelta.subVectors(intersections[0].point, vCurrent);\n        vCurrent.add(vDelta.setLength(speed));\n      }\n    };\n  }()\n});","map":{"version":3,"names":["module","exports","AFRAME","registerComponent","schema","destination","type","active","default","speed","init","system","el","sceneEl","systems","nav","addAgent","group","path","raycaster","THREE","Raycaster","remove","removeAgent","update","length","updateNavLocation","tick","vDest","Vector3","vDelta","vNext","t","dt","data","position","object3D","getGroup","getPath","copy","emit","console","warn","setAttribute","vCurrent","vWaypoint","subVectors","distance","gazeTarget","shift","setLength","add","y","lookAt","ray","origin","direction","intersections","intersectObject","getNavMesh","point"],"sources":["X:/Project/back/node_modules/aframe-extras/src/pathfinding/nav-agent.js"],"sourcesContent":["module.exports = AFRAME.registerComponent('nav-agent', {\n  schema: {\n    destination: {type: 'vec3'},\n    active: {default: false},\n    speed: {default: 2}\n  },\n  init: function () {\n    this.system = this.el.sceneEl.systems.nav;\n    this.system.addAgent(this);\n    this.group = null;\n    this.path = [];\n    this.raycaster = new THREE.Raycaster();\n  },\n  remove: function () {\n    this.system.removeAgent(this);\n  },\n  update: function () {\n    this.path.length = 0;\n  },\n  updateNavLocation: function () {\n    this.group = null;\n    this.path = [];\n  },\n  tick: (function () {\n    const vDest = new THREE.Vector3();\n    const vDelta = new THREE.Vector3();\n    const vNext = new THREE.Vector3();\n\n    return function (t, dt) {\n      const el = this.el;\n      const data = this.data;\n      const raycaster = this.raycaster;\n      const speed = data.speed * dt / 1000;\n\n      if (!data.active) return;\n\n      // Use PatrolJS pathfinding system to get shortest path to target.\n      if (!this.path.length) {\n        const position = this.el.object3D.position;\n        this.group = this.group || this.system.getGroup(position);\n        this.path = this.system.getPath(position, vDest.copy(data.destination), this.group) || [];\n        el.emit('navigation-start');\n      }\n\n      // If no path is found, exit.\n      if (!this.path.length) {\n        console.warn('[nav] Unable to find path to %o.', data.destination);\n        this.el.setAttribute('nav-agent', {active: false});\n        el.emit('navigation-end');\n        return;\n      }\n\n      // Current segment is a vector from current position to next waypoint.\n      const vCurrent = el.object3D.position;\n      const vWaypoint = this.path[0];\n      vDelta.subVectors(vWaypoint, vCurrent);\n\n      const distance = vDelta.length();\n      let gazeTarget;\n\n      if (distance < speed) {\n        // If <1 step from current waypoint, discard it and move toward next.\n        this.path.shift();\n\n        // After discarding the last waypoint, exit pathfinding.\n        if (!this.path.length) {\n          this.el.setAttribute('nav-agent', {active: false});\n          el.emit('navigation-end');\n          return;\n        }\n\n        vNext.copy(vCurrent);\n        gazeTarget = this.path[0];\n      } else {\n        // If still far away from next waypoint, find next position for\n        // the current frame.\n        vNext.copy(vDelta.setLength(speed)).add(vCurrent);\n        gazeTarget = vWaypoint;\n      }\n\n      // Look at the next waypoint.\n      gazeTarget.y = vCurrent.y;\n      el.object3D.lookAt(gazeTarget);\n\n      // Raycast against the nav mesh, to keep the agent moving along the\n      // ground, not traveling in a straight line from higher to lower waypoints.\n      raycaster.ray.origin.copy(vNext);\n      raycaster.ray.origin.y += 1.5;\n      raycaster.ray.direction.y = -1;\n      const intersections = raycaster.intersectObject(this.system.getNavMesh());\n\n      if (!intersections.length) {\n        // Raycasting failed. Step toward the waypoint and hope for the best.\n        vCurrent.copy(vNext);\n      } else {\n        // Re-project next position onto nav mesh.\n        vDelta.subVectors(intersections[0].point, vCurrent);\n        vCurrent.add(vDelta.setLength(speed));\n      }\n\n    };\n  }())\n});\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}